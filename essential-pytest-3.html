<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="Simon Larsén" />
    <meta name="generator" content="Pelican (VoidyBootstrap theme)" />

    <title>Essential pytest pt. 3: Rerunning failed tests (and the pytest cache) - slar.se</title>

   
        <link rel="stylesheet"
              href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
              integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
              crossorigin="anonymous" />
      <link rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
            integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
            crossorigin="anonymous">


      <link rel="stylesheet" href="https://slar.se/theme/css/pygment.css" />
      <link rel="stylesheet" href="https://slar.se/theme/css/voidybootstrap.css" />

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js" integrity="sha384-FFgGfda92tXC8nCNOxrCQ3R8x1TNkMFqDZVQdDaaJiiVbjkPBXIJBx0o7ETjy8Bh" crossorigin="anonymous"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js" integrity="sha384-ZoaMbDF+4LeFxg6WdScQ9nnR1QC2MIRxA1O9KWEXQwns1G8UNyIEZIQidzb0T1fo" crossorigin="anonymous"></script>
    <![endif]-->

    <link rel="shortcut icon" href="https://slar.se/favicon.ico" />
        <link href="https://slar.se/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="slar.se Atom Feed" />
  </head>

  <body>
   
    <nav class="navbar navbar-default">
      <div class="container">
	   <div class="navbar-header">
		<button type="button" class="navbar-toggle" 
				data-toggle="collapse" data-target="#main-navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="https://slar.se/" rel="home">
          <i class="fas fa-home fa-fw fa-lg"> </i> </a>
       </div>

      <div class="collapse navbar-collapse" id="main-navbar-collapse">
        <ul class="nav navbar-nav">
              <li>
                <a href="https://slar.se/pages/about.html">About</a>
              </li>
              <li>
                <a href="https://slar.se/pages/publications-and-essays.html">Publications and Essays</a>
              </li>
              <li>
                <a href="https://slar.se/pages/projects.html">Projects</a>
              </li>
            <li class="divider"></li>
            <li class="">
              <a href="https://slar.se/archives.html">Archives</a>
            </li>
          <li class="divider"></li>
            <li><a href="https://slar.se/feeds/all.atom.xml" 
                   type="application/atom+xml" rel="alternate">
                <i class="fas fa-rss fa-fw fa-lg"></i> </a></li>
        </ul> <!-- /nav -->
      </div> <!-- /navbar-collapse -->
	  </div> <!-- /container -->
    </nav> <!-- /navbar -->

	<div class="jumbotron" id="overview">
	  <div class="container">
		<h1><a href="https://slar.se/">slar.se</a></h1>
	  </div>
	</div>

    <div class="container" id="main-container">
      <div class="row">
        <div class="col-md-9" id="content">
<article itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
  <header class="article-header">
<abbr class="article-header-date">
  Sat 03 October 2020
</abbr> <h1>
  <a href="https://slar.se/essential-pytest-3.html" rel="bookmark"
     title="Permalink to Essential pytest pt. 3: Rerunning failed tests (and the pytest cache)">
    Essential pytest pt. 3: Rerunning failed tests (and the pytest cache)
  </a>
</h1><div class="article-header-info">
  <p>
      Posted by <a href="https://slar.se/author/simon-larsen.html">Simon Larsén</a>
    in 
    <a href="https://slar.se/category/testing.html">
      Testing</a>
    &nbsp;&nbsp;
  </p>
</div> <!-- /.article-header-info -->  </header>
  <div class="content-body" itemprop="text articleBody">
	<p>This is the third part of a series of small articles detailing some of the
functionality of the <a href="https://docs.pytest.org/en/latest/">pytest</a> testing
framework that I find most essential. The series assumes you know how to run
tests with <code>pytest</code> already.</p>
<p>In this third part, we'll take a super quick look at the <code>--lf</code> flag that lets
us rerun failed tests, as well as the caching mechanism that makes it possible.</p>
<h2>Using <code>--lf</code> to rerun failed tests</h2>
<p>In this article, we'll use the test suite from <a href="https://slar.se/essential-pytest-1.html">the first
article</a>.</p>
<div class="highlight"><pre><span></span><span class="c1"># test_mul.py</span>
<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">*</span> <span class="n">lhs</span>

<span class="k">def</span> <span class="nf">test_multiply_equal_numbers</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">mul</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">25</span>

<span class="k">def</span> <span class="nf">test_multiply_by_zero</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">mul</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_multiply_different_numbers</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">mul</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span>
</pre></div>


<p>Just like in that article, the implementation of <code>mul</code> is broken.</p>
<div class="highlight"><pre><span></span>$ pytest -v --tb<span class="o">=</span><span class="nv">no</span>
<span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===========================</span>
platform linux -- Python <span class="m">3</span>.8.5, pytest-6.1.0, py-1.9.0, pluggy-0.13.1
cachedir: .pytest_cache
rootdir: /home/slarse/python
plugins: repobee-3.0.0b3
collected <span class="m">3</span> items                                                        

test_mul.py::test_multiply_equal_numbers PASSED                    <span class="o">[</span> <span class="m">33</span>%<span class="o">]</span>
test_mul.py::test_multiply_by_zero FAILED                          <span class="o">[</span> <span class="m">66</span>%<span class="o">]</span>
test_mul.py::test_multiply_different_numbers FAILED                <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">========================</span> short <span class="nb">test</span> summary <span class="nv">info</span> <span class="o">=========================</span>
FAILED test_mul.py::test_multiply_by_zero - assert <span class="nv">1</span> <span class="o">==</span> <span class="m">0</span>
FAILED test_mul.py::test_multiply_different_numbers - assert <span class="nv">25</span> <span class="o">==</span> <span class="nv">15</span>
<span class="o">======================</span> <span class="m">2</span> failed, <span class="m">1</span> passed in <span class="m">0</span>.05s <span class="o">=======================</span>
</pre></div>


<p>Note how 2 tests failed. <code>pytest</code> caches the failed tests from the last run,
which enables us to rerun them with the <code>--lf|--last-failed</code> flag. So let's do
that, and show some more traceback information while we're at it. Note that
only the failing tests are executed.</p>
<div class="highlight"><pre><span></span>$ pytest -v --lf --tb<span class="o">=</span><span class="nv">short</span>
<span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===========================</span>
platform linux -- Python <span class="m">3</span>.8.5, pytest-6.1.0, py-1.9.0, pluggy-0.13.1
cachedir: .pytest_cache
rootdir: /home/slarse/python
plugins: repobee-3.0.0b3
collected <span class="m">2</span> items                                                        
run-last-failure: rerun previous <span class="m">2</span> failures

test_mul.py::test_multiply_by_zero FAILED                          <span class="o">[</span> <span class="m">50</span>%<span class="o">]</span>
test_mul.py::test_multiply_different_numbers FAILED                <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span> <span class="nv">FAILURES</span> <span class="o">================================</span>
_________________________ test_multiply_by_zero __________________________
test_mul.py:8: in test_multiply_by_zero
    assert mul<span class="o">(</span><span class="m">1</span>, <span class="m">0</span><span class="o">)</span> <span class="o">==</span> <span class="m">0</span>
E   assert <span class="nv">1</span> <span class="o">==</span> <span class="m">0</span>
E     +1
E     -0
____________________ test_multiply_different_numbers _____________________
test_mul.py:11: in test_multiply_different_numbers
    assert mul<span class="o">(</span><span class="m">5</span>, <span class="m">3</span><span class="o">)</span> <span class="o">==</span> <span class="m">15</span>
E   assert <span class="nv">25</span> <span class="o">==</span> <span class="m">15</span>
E     +25
E     -15
<span class="o">========================</span> short <span class="nb">test</span> summary <span class="nv">info</span> <span class="o">=========================</span>
FAILED test_mul.py::test_multiply_by_zero - assert <span class="nv">1</span> <span class="o">==</span> <span class="m">0</span>
FAILED test_mul.py::test_multiply_different_numbers - assert <span class="nv">25</span> <span class="o">==</span> <span class="nv">15</span>
<span class="o">===========================</span> <span class="m">2</span> failed in <span class="m">0</span>.12s <span class="o">============================</span>
</pre></div>


<p>My primary use case for <code>--lf</code> is for sorting out bugs. Every time a test
passes, it is removed from the last-failed cache, and thus does not run the next
time <code>--lf</code> is specified. This way, it's easy to quickly target only failing
tests, and systematically eliminate them one by one.</p>
<blockquote>
<p><strong>Pitfall:</strong> A common mistake is to use <code>--lf</code> to eliminate the failing tests
one by one, and then forget to run all tests when the last of the initially
failing tests passes. It's entirely possible to fix the implementation such
that a test <code>A</code> passes, and then subsequently reintroduce the same problem in
addressing another test, but at that point <code>A</code> is no longer executing with
<code>--lf</code>.</p>
</blockquote>
<h2>Interacting with the cache</h2>
<p>I mentioned that the failed tests from the last run are stored in a cache. This
cache is located in the <code>.pytest_cache</code> directory of the current working
directory. There are a few flags to interact with said cache. First, you can
execute <code>pytest</code> with the <code>--cache-show</code> flag to show the current contents of
the cache.</p>
<div class="highlight"><pre><span></span>pytest --cache-show
<span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===========================</span>
platform linux -- Python <span class="m">3</span>.8.5, pytest-6.1.0, py-1.9.0, pluggy-0.13.1
rootdir: /home/slarse/python
plugins: repobee-3.0.0b3
cachedir: /home/slarse/python/.pytest_cache
-------------------------- cache values <span class="k">for</span> <span class="s1">&#39;*&#39;</span> --------------------------
cache/lastfailed contains:
  <span class="o">{</span><span class="s1">&#39;test_mul.py::test_multiply_by_zero&#39;</span>: True,
   <span class="s1">&#39;test_mul.py::test_multiply_different_numbers&#39;</span>: True<span class="o">}</span>
cache/nodeids contains:
  <span class="o">[</span><span class="s1">&#39;test_mul.py::test_multiply_by_zero&#39;</span>,
   <span class="s1">&#39;test_mul.py::test_multiply_different_numbers&#39;</span>,
   <span class="s1">&#39;test_mul.py::test_multiply_equal_numbers&#39;</span><span class="o">]</span>
cache/stepwise contains:
  <span class="o">[]</span>

<span class="o">=========================</span> no tests ran in <span class="m">0</span>.00s <span class="o">==========================</span>
</pre></div>


<p>Here, we can for example see the contents of the last-failed cache
(<code>cache/lastfailed</code>), and the tests currently known by <code>pytest</code>
(<code>cache/nodeids</code>). It's possible to supply <code>--cache-show</code> with an optional
value, in order to show only some part of the cache. For example,
<code>--cache-show=lastfailed</code> shows only the last-failed cache contents.</p>
<p>On occasion, the cache may get into an inconsistent state, typically due to
strange interactions by the user. This has happened to me on several occasions,
with tests simply not executing as I expect them to. At that point, supplying
the <code>--cache-clear</code> flag to a test run will clear the cache. Alternatively, you
may simply remove the <code>.pytest_cache</code> directory.</p>
<h2>Summary</h2>
<p>Being able to execute only the failing tests from the previous test run is a
very handy feature when addressing bugs, both saving time in test execution and
limiting the amount of output shown to the user. It's however important to
remember to execute all tests after the last failing test passes, so as to check
for regressions. One should also be aware that the functionality hinges on
caching in the <code>.pytest_cache</code> directory, which on rare occasions may need to be
cleared.</p>
  </div>
  

</article>
        </div><!-- /content -->

        <div class="col-md-3 sidebar-nav" id="sidebar">

<div class="row">

<div class="col-xs-6 col-md-12">
<h4><i class="fas fa-comment fa-fw fa-lg"></i> Social</h4>
<ul class="list-unstyled social-links">
    <li><a href="https://www.linkedin.com/in/simon-lars%C3%A9n-b665b3102/" target="_blank">
	  <i class="fab fa-linkedin fa-fw fa-lg" title="LinkedIn"></i>
		LinkedIn
	</a></li>
    <li><a href="https://github.com/slarse" target="_blank">
	  <i class="fab fa-github-square fa-fw fa-lg" title="GitHub"></i>
		GitHub
	</a></li>
</ul>
</div>

<div class="col-xs-6 col-md-12">
<h4><i class="fas fa-folder fa-fw fa-lg"></i> Categories</h4>
<ul class="list-unstyled category-links">
  <li><a href="https://slar.se/category/blog.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Blog</a></li>
  <li><a href="https://slar.se/category/linux.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Linux</a></li>
  <li><a href="https://slar.se/category/programming.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Programming</a></li>
  <li><a href="https://slar.se/category/testing.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Testing</a></li>
  <li><a href="https://slar.se/category/tip-of-the-week.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Tip of the Week</a></li>
</ul>
</div>

</div> <!-- /row -->

<h4><i class="fas fa-tags fa-fw fa-lg"></i> Tags</h4>
<p class="tag-cloud">
    <span class="tag-4">
      <a href="https://slar.se/tag/podcast.html">
          <i class="fas fa-tag"></i>
        podcast
      </a>
    </span>
    <span class="tag-3">
      <a href="https://slar.se/tag/data-structures.html">
          <i class="fas fa-tag"></i>
        data structures
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/tornadofx.html">
          <i class="fas fa-tag"></i>
        tornadofx
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/enums.html">
          <i class="fas fa-tag"></i>
        enums
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/linux.html">
          <i class="fas fa-tag"></i>
        linux
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/html.html">
          <i class="fas fa-tag"></i>
        html
      </a>
    </span>
    <span class="tag-1">
      <a href="https://slar.se/tag/python.html">
          <i class="fas fa-tag"></i>
        python
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/gradle.html">
          <i class="fas fa-tag"></i>
        gradle
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/blog.html">
          <i class="fas fa-tag"></i>
        blog
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/kuizzy.html">
          <i class="fas fa-tag"></i>
        kuizzy
      </a>
    </span>
    <span class="tag-3">
      <a href="https://slar.se/tag/bst.html">
          <i class="fas fa-tag"></i>
        bst
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/css.html">
          <i class="fas fa-tag"></i>
        css
      </a>
    </span>
    <span class="tag-3">
      <a href="https://slar.se/tag/java.html">
          <i class="fas fa-tag"></i>
        java
      </a>
    </span>
    <span class="tag-1">
      <a href="https://slar.se/tag/kotlin.html">
          <i class="fas fa-tag"></i>
        kotlin
      </a>
    </span>
    <span class="tag-1">
      <a href="https://slar.se/tag/totw.html">
          <i class="fas fa-tag"></i>
        totw
      </a>
    </span>
    <span class="tag-1">
      <a href="https://slar.se/tag/bash.html">
          <i class="fas fa-tag"></i>
        bash
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/testing.html">
          <i class="fas fa-tag"></i>
        testing
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/unit-testing.html">
          <i class="fas fa-tag"></i>
        unit testing
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/testing-tips.html">
          <i class="fas fa-tag"></i>
        testing tips
      </a>
    </span>
    <span class="tag-3">
      <a href="https://slar.se/tag/git.html">
          <i class="fas fa-tag"></i>
        git
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/pytest.html">
          <i class="fas fa-tag"></i>
        pytest
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/javascript.html">
          <i class="fas fa-tag"></i>
        javascript
      </a>
    </span>
    <span class="tag-4">
      <a href="https://slar.se/tag/intellij.html">
          <i class="fas fa-tag"></i>
        intellij
      </a>
    </span>
    <span class="tag-2">
      <a href="https://slar.se/tag/exposed.html">
          <i class="fas fa-tag"></i>
        exposed
      </a>
    </span>
</p>
<h4><i class="fas fa-rss fa-fw fa-lg"></i> Feeds</h4>
<ul class="list-unstyled">
    <li><a href="https://slar.se/feeds/all.atom.xml" 
		   type="application/atom+xml" rel="alternate">
		<i class="fas fa-rss-square fa-fw fa-lg"></i> Atom Feed</a></li>
</ul>

<hr />

        </div><!--/sidebar -->
      </div><!--/row-->
    </div><!--/.container /#main-container -->

    <footer id="site-footer">
 
      <address id="site-colophon">
        <p class="text-center text-muted">
        Site built using <a href="http://getpelican.com/" target="_blank">Pelican</a>
        &nbsp;&bull;&nbsp; Theme based on
        <a href="http://www.voidynullness.net/page/voidy-bootstrap-pelican-theme/"
           target="_blank">VoidyBootstrap</a> by 
        <a href="http://voidynullness.net"
           target="_blank">RKI</a>  
        </p>
      </address><!-- /colophon  -->
    </footer>


    <!-- javascript -->
   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>


  </body>
</html>